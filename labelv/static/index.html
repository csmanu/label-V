<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <link href="http://hayageek.github.io/jQuery-Upload-File/4.0.11/uploadfile.css" rel="stylesheet">
    <script src="http://hayageek.github.io/jQuery-Upload-File/4.0.11/jquery.uploadfile.min.js"></script>

    <link type="text/css" rel="stylesheet" href="http://annotorious.github.com/latest/annotorious.css" />
    <script type="text/javascript" src="http://annotorious.github.com/latest/annotorious.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/2.6.0/async.min.js"></script>

    <link type="text/css" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />

    <style>
      #frame {
        border: 2px solid white;
      }
      #frame.modified {
        border-color: red;
      }
      .wait-loading {
        position: absolute;
        z-index: 10;
        margin-top: 30px;
        margin-left: 30px;
        color: white;
        font-size: 200px;
      }
      .wait-loading.done {
        display: none;
      }
    </style>

    <script>
      sessionId = randomString(20);
      videoId = null;
      currentFrame = null;
      modified = false;

      function randomString(n) {
        var r="";
        while(n--)r+=String.fromCharCode((r=Math.random()*62|0,r+=r>9?(r<36?55:61):48));
        return r;
      }

      function setModified(m) {
        modified = m;
        $("#frame").toggleClass("modified", m);
      };

      anno.addHandler('onAnnotationRemoved', function(annotation) { setModified(true); });
      anno.addHandler('onAnnotationCreated', function(annotation) { setModified(true); });
      anno.addHandler('onAnnotationUpdated', function(annotation) { setModified(true); });

      function loadFrame() {
        $(".wait-loading").removeClass("done");
        async.series([
          function (cb) {
            window.location.hash = JSON.stringify({video: videoId, session: sessionId, frame:currentFrame});
            imageLoaded = cb;
            $("#frame").attr({src: "/video/" + videoId + "/image/" + currentFrame.toString()});
          },
          function (cb) {
            anno.removeAll();
            anno.makeAnnotatable($("#frame")[0]);
            $.getJSON('/video/' + videoId + '/session/' + sessionId + '/bboxes/' + currentFrame.toString(), function (data) {
              var w = $("#frame").innerWidth();
              var h = $("#frame").innerHeight();
              data.bboxes.map(function (bbox) {
                anno.addAnnotation({
                  src : $("#frame").attr('src'),
                  text : '',
                  shapes : [{
                    type : 'rect',
                    geometry : {x : bbox[0]/w, y: bbox[1]/h, width: bbox[2]/w, height: bbox[3]/h}
                  }]
                });
              });
              setModified(false);
              $(".wait-loading").addClass("done");
              cb();
            });             
          }
        ]);
       }
      function saveFrame(cb) {
        if (modified) {
          var newBboxes = anno.getAnnotations().map(function (a) {
            var g = a.shapes[0].geometry;
            var w = $("#frame").innerWidth();
            var h = $("#frame").innerHeight();
            return [
              Math.floor(g.x * w),
              Math.floor(g.y * h),
              Math.floor(g.width * w),
              Math.floor(g.height * h)
            ];
          });
          console.log("SAVING MODIFICATIONS");
          $.ajax({
            url: '/video/' + videoId + '/session/' + sessionId + '/bboxes/' + currentFrame.toString(),
            type: "POST",
            data: JSON.stringify(newBboxes),
            contentType:"application/json; charset=utf-8",
            dataType:"json",
            success: function (data) {
              cb();
            }
          });
        } else {
          console.log("NO MODIFICATIONS TO SAVE");
          cb();
        }
      }
      $(document).ready(function() {
        $("#frame").on("load", function () {
          imageLoaded();
        });

	$("#fileuploader").uploadFile({
          url:"/video",
          fileName:"file",
          returnType: "json",
          onSuccess:function(files,data,xhr,pd) {
            videoId = data.id;
            currentFrame = 0;
            loadFrame();
            console.log(data);
          }
        });
        $("#next").click(function () {
          saveFrame(function () {
            currentFrame+=10;
            loadFrame();
          });
        });
        $("#prev").click(function () {
          saveFrame(function () {
            currentFrame-=10;
            loadFrame();
          });
        });

        if (window.location.hash != "") {
          var args = JSON.parse(window.location.hash.substr(1));
          videoId = args.video;
          sessionId = args.session;
          currentFrame = args.frame;
          loadFrame();
        }
      });
    </script>
  </head>
  <body>
    Upload video: <div id="fileuploader">Upload</div>

    <div>
      <button id="prev">Prev</button>
      <button id="next">Next</button>
    </div>
    <i class="fa fa-spinner fa-spin wait-loading" aria-hidden="true"></i>
    <img id="frame" style="min-width:100px;"></img>
    
  </body>
</html>
